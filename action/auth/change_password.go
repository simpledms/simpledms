package auth

import (
	"log"
	"net/http"

	autil "github.com/simpledms/simpledms/action/util"
	"github.com/simpledms/simpledms/common"
	"github.com/simpledms/simpledms/ctxx"
	"github.com/simpledms/simpledms/event"
	"github.com/simpledms/simpledms/model/modelmain"
	wx "github.com/simpledms/simpledms/ui/widget"
	"github.com/simpledms/simpledms/util/actionx"
	"github.com/simpledms/simpledms/util/e"
	"github.com/simpledms/simpledms/util/httpx"
)

// generated by junie
type ChangePasswordData struct {
	CurrentOrTemporaryPassword string `validate:"required" form_attr_type:"password"`
	NewPassword                string `validate:"required" form_attr_type:"password"`
	ConfirmPassword            string `validate:"required" form_attr_type:"password"`
}

// generated by junie
type ChangePassword struct {
	infra   *common.Infra
	actions *Actions
	*actionx.Config
	*autil.FormHelper[ChangePasswordData]
}

// generated by junie
func NewChangePassword(infra *common.Infra, actions *Actions) *ChangePassword {
	config := actionx.NewConfig(actions.Route("change-password"), false)
	return &ChangePassword{
		infra:   infra,
		actions: actions,
		Config:  config,
		FormHelper: autil.NewFormHelperX[ChangePasswordData](
			infra,
			config,
			wx.T("Change password"),
			wx.T("Change"),
		),
	}
}

// generated by junie
func (qq *ChangePassword) Data(currentPassword, newPassword, confirmPassword string) *ChangePasswordData {
	return &ChangePasswordData{
		CurrentOrTemporaryPassword: currentPassword,
		NewPassword:                newPassword,
		ConfirmPassword:            confirmPassword,
	}
}

// generated by junie
func (qq *ChangePassword) Handler(
	rw httpx.ResponseWriter,
	req *httpx.Request,
	ctx ctxx.Context,
) error {
	// Ensure user is logged in
	if !ctx.IsMainCtx() {
		return e.NewHTTPErrorf(http.StatusUnauthorized, "You must be logged in to change your password.")
	}

	data, err := autil.FormData[ChangePasswordData](rw, req, ctx)
	if err != nil {
		return err
	}

	accountx := ctx.MainCtx().Account
	accountm := modelmain.NewAccount(accountx)

	err = accountm.ChangePassword(ctx, data.CurrentOrTemporaryPassword, data.NewPassword, data.ConfirmPassword)
	if err != nil {
		log.Println(err)
		return err
	}

	rw.Header().Set("HX-Reswap", "none")
	rw.Header().Set("HX-Trigger", event.PasswordChanged.String())

	rw.AddRenderables(wx.NewSnackbarf("Password changed successfully."))
	return nil
}
