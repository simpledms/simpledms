import{a as L}from"../chunk-X4UV3AIF.js";import{a as t}from"../chunk-CLGSKES3.js";import{m as y,n as v,q as D}from"../chunk-RMJY7HHF.js";import"../chunk-FW4363Y4.js";var j={name:"@uppy/audio",description:"Uppy plugin that records audio using the device\u2019s microphone.",version:"2.2.2",license:"MIT",main:"lib/index.js",style:"dist/style.min.css",keywords:["file uploader","uppy","uppy-plugin","audio","microphone","sound","record","mediarecorder"],type:"module",homepage:"https://uppy.io",bugs:{url:"https://github.com/transloadit/uppy/issues"},repository:{type:"git",url:"git+https://github.com/transloadit/uppy.git"},files:["src","lib","dist","CHANGELOG.md"],dependencies:{"@uppy/utils":"^6.2.2",preact:"^10.5.13"},devDependencies:{cssnano:"^7.0.7",jsdom:"^26.1.0",postcss:"^8.5.6","postcss-cli":"^11.0.1",sass:"^1.89.2",typescript:"^5.8.3",vitest:"^3.2.4"},peerDependencies:{"@uppy/core":"^4.5.2"},publishConfig:{access:"public"},scripts:{build:"tsc --build tsconfig.build.json","build:css":"sass --load-path=../../ src/style.scss dist/style.css && postcss dist/style.css -u cssnano -o dist/style.min.css",typecheck:"tsc --build",test:"vitest run --environment=jsdom --silent='passed-only'"}};var N={strings:{pluginNameAudio:"Audio",startAudioRecording:"Begin audio recording",stopAudioRecording:"Stop audio recording",allowAudioAccessTitle:"Please allow access to your microphone",allowAudioAccessDescription:"In order to record audio, please allow microphone access for this site.",noAudioTitle:"Microphone Not Available",noAudioDescription:"In order to record audio, please connect a microphone or another audio input device",recordingStoppedMaxSize:"Recording stopped because the file size is about to exceed the limit",recordingLength:"Recording length %{recording_length}",submitRecordedFile:"Submit recorded file",discardRecordedFile:"Discard recorded file"}};var P=o=>{let{icon:e,hasAudio:i,i18n:s}=o;return t("div",{className:"uppy-Audio-permissons",children:[t("div",{className:"uppy-Audio-permissonsIcon",children:e()}),t("div",{className:"uppy-Audio-title",children:s(i?"allowAudioAccessTitle":"noAudioTitle")}),t("p",{children:s(i?"allowAudioAccessDescription":"noAudioDescription")})]})};var z=({currentDeviceId:o,audioSources:e,onChangeSource:i})=>t("div",{className:"uppy-Audio-videoSource",children:t("select",{className:"uppy-u-reset uppy-Audio-audioSource-select",onChange:s=>{i(s.target.value)},children:e.map(s=>t("option",{value:s.deviceId,selected:s.deviceId===o,children:s.label},s.deviceId))})});function F(o){return typeof o=="function"}function h(o){return F(o)?o():o}var p=class{canvas;canvasContext;width;height;analyser;bufferLength;dataArray;onDrawFrame;streamSource;audioContext;source;constructor(e,i={}){let s=i.canvas||{},r=i.canvasContext||{};this.analyser=null,this.bufferLength=0,this.canvas=e,this.width=h(s.width)||this.canvas.width,this.height=h(s.height)||this.canvas.height,this.canvas.width=this.width,this.canvas.height=this.height,this.canvasContext=this.canvas.getContext("2d"),this.canvasContext.fillStyle=h(r.fillStyle)||"rgb(255, 255, 255)",this.canvasContext.strokeStyle=h(r.strokeStyle)||"rgb(0, 0, 0)",this.canvasContext.lineWidth=h(r.lineWidth)||1,this.onDrawFrame=F(i.onDrawFrame)?i.onDrawFrame:()=>{}}addSource(e){this.streamSource=e,this.audioContext=this.streamSource.context,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.bufferLength=this.analyser.frequencyBinCount,this.source=this.audioContext.createBufferSource(),this.dataArray=new Uint8Array(this.bufferLength),this.analyser.getByteTimeDomainData(this.dataArray),this.streamSource.connect(this.analyser)}draw(){let{analyser:e,dataArray:i,bufferLength:s}=this,r=this.canvasContext,n=this.width,a=this.height;e&&e.getByteTimeDomainData(i),r.fillRect(0,0,n,a),r.beginPath();let l=n*1/s,d=0;s||r.moveTo(0,this.height/2);for(let c=0;c<s;c++){let m=i[c]/128*(a/2);c===0?r.moveTo(d,m):r.lineTo(d,m),d+=l}r.lineTo(n,a/2),r.stroke(),this.onDrawFrame(this),requestAnimationFrame(this.#o)}#o=()=>this.draw()};function O({onDiscard:o,i18n:e}){return t("button",{className:"uppy-u-reset uppy-c-btn uppy-Audio-button",type:"button",title:e("discardRecordedFile"),"aria-label":e("discardRecordedFile"),onClick:o,"data-uppy-super-focusable":!0,children:t("svg",{width:"13",height:"13",viewBox:"0 0 13 13",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",className:"uppy-c-icon",children:t("g",{fill:"#FFF",fillRule:"evenodd",children:[t("path",{d:"M.496 11.367L11.103.76l1.414 1.414L1.911 12.781z"}),t("path",{d:"M11.104 12.782L.497 2.175 1.911.76l10.607 10.606z"})]})})})}var k=O;function S({recording:o,onStartRecording:e,onStopRecording:i,i18n:s}){return o?t("button",{className:"uppy-u-reset uppy-c-btn uppy-Audio-button",type:"button",title:s("stopAudioRecording"),"aria-label":s("stopAudioRecording"),onClick:i,"data-uppy-super-focusable":!0,children:t("svg",{"aria-hidden":"true",focusable:"false",className:"uppy-c-icon",width:"100",height:"100",viewBox:"0 0 100 100",children:t("rect",{x:"15",y:"15",width:"70",height:"70"})})}):t("button",{className:"uppy-u-reset uppy-c-btn uppy-Audio-button",type:"button",title:s("startAudioRecording"),"aria-label":s("startAudioRecording"),onClick:e,"data-uppy-super-focusable":!0,children:t("svg",{"aria-hidden":"true",focusable:"false",className:"uppy-c-icon",width:"14px",height:"20px",viewBox:"0 0 14 20",children:t("path",{d:"M7 14c2.21 0 4-1.71 4-3.818V3.818C11 1.71 9.21 0 7 0S3 1.71 3 3.818v6.364C3 12.29 4.79 14 7 14zm6.364-7h-.637a.643.643 0 0 0-.636.65V9.6c0 3.039-2.565 5.477-5.6 5.175-2.645-.264-4.582-2.692-4.582-5.407V7.65c0-.36-.285-.65-.636-.65H.636A.643.643 0 0 0 0 7.65v1.631c0 3.642 2.544 6.888 6.045 7.382v1.387H3.818a.643.643 0 0 0-.636.65v.65c0 .36.285.65.636.65h6.364c.351 0 .636-.29.636-.65v-.65c0-.36-.285-.65-.636-.65H7.955v-1.372C11.363 16.2 14 13.212 14 9.6V7.65c0-.36-.285-.65-.636-.65z",fill:"#FFF","fill-rule":"nonzero"})})})}function x(o){return`${Math.floor(o/60)}:${String(o%60).padStart(2,"0")}`}function A({recordingLengthSeconds:o}){let e=x(o);return t("span",{children:e})}function H({onSubmit:o,i18n:e}){return t("button",{className:"uppy-u-reset uppy-c-btn uppy-Audio-button uppy-Audio-button--submit",type:"button",title:e("submitRecordedFile"),"aria-label":e("submitRecordedFile"),onClick:o,"data-uppy-super-focusable":!0,children:t("svg",{width:"12",height:"9",viewBox:"0 0 12 9",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",className:"uppy-c-icon",children:t("path",{fill:"#fff",fillRule:"nonzero",d:"M10.66 0L12 1.31 4.136 9 0 4.956l1.34-1.31L4.136 6.38z"})})})}var M=H;function b(o){let{stream:e,recordedAudio:i,onStop:s,recording:r,supportsRecording:n,audioSources:a,showAudioSourceDropdown:l,onSubmit:d,i18n:c,onStartRecording:R,onStopRecording:m,onDiscardRecordedAudio:I,recordingLengthSeconds:B}=o,C=v(null),g=v();y(()=>()=>{g.current=null,s()},[s]),y(()=>{if(!i&&(g.current=new p(C.current,{canvas:{width:600,height:600},canvasContext:{lineWidth:2,fillStyle:"rgb(0,0,0)",strokeStyle:"green"}}),g.current.draw(),e)){let _=new AudioContext().createMediaStreamSource(e);g.current.addSource(_)}},[i,e]);let u=i!=null,T=!u&&n,E=l&&!u&&a&&a.length>1;return t("div",{className:"uppy-Audio-container",children:[t("div",{className:"uppy-Audio-audioContainer",children:u?t("audio",{className:"uppy-Audio-player",controls:!0,src:i}):t("canvas",{ref:C,className:"uppy-Audio-canvas"})}),t("div",{className:"uppy-Audio-footer",children:[t("div",{className:"uppy-Audio-audioSourceContainer",children:E?z(o):null}),t("div",{className:"uppy-Audio-buttonContainer",children:[T&&t(S,{recording:r,onStartRecording:R,onStopRecording:m,i18n:c}),u&&t(M,{onSubmit:d,i18n:c}),u&&t(k,{onDiscard:I,i18n:c})]}),t("div",{className:"uppy-Audio-recordingLength",children:!u&&t(A,{recordingLengthSeconds:B})})]})]})}function w(){return typeof MediaRecorder=="function"&&typeof MediaRecorder.prototype?.start=="function"}var f=class extends D{static VERSION=j.version;#o;icon;#i=null;#a=!1;#e=null;#t=null;#r=null;#s;#u;constructor(e,i){super(e,i),this.#s=navigator.mediaDevices,this.#u=this.#s!=null,this.id=this.opts.id||"Audio",this.type="acquirer",this.icon=()=>t("svg",{className:"uppy-DashboardTab-iconAudio","aria-hidden":"true",focusable:"false",width:"32px",height:"32px",viewBox:"0 0 32 32",children:t("path",{d:"M21.143 12.297c.473 0 .857.383.857.857v2.572c0 3.016-2.24 5.513-5.143 5.931v2.64h2.572a.857.857 0 110 1.714H12.57a.857.857 0 110-1.714h2.572v-2.64C12.24 21.24 10 18.742 10 15.726v-2.572a.857.857 0 111.714 0v2.572A4.29 4.29 0 0016 20.01a4.29 4.29 0 004.286-4.285v-2.572c0-.474.384-.857.857-.857zM16 6.5a3 3 0 013 3v6a3 3 0 01-6 0v-6a3 3 0 013-3z",fill:"currentcolor","fill-rule":"nonzero"})}),this.defaultLocale=N,this.opts={...i},this.i18nInit(),this.title=this.i18n("pluginNameAudio"),this.setPluginState({hasAudio:!1,audioReady:!1,cameraError:null,recordingLengthSeconds:0,audioSources:[],currentDeviceId:null})}#h(){return this.#s?this.#s.enumerateDevices().then(e=>e.some(i=>i.kind==="audioinput")):Promise.resolve(!1)}#c=e=>{if(!this.#u)return Promise.reject(new Error("Microphone access not supported"));this.#a=!0,this.#h().then(i=>(this.setPluginState({hasAudio:i}),this.#s.getUserMedia({audio:!0}).then(s=>{this.#i=s;let r=null,n=s.getAudioTracks();e?.deviceId?r=n.findLast(a=>a.getSettings().deviceId===e.deviceId):r=n[0].getSettings().deviceId,this.#d(),this.setPluginState({currentDeviceId:r,audioReady:!0})}).catch(s=>{this.setPluginState({audioReady:!1,cameraError:s}),this.uppy.info(s.message,"error")})))};#p=()=>{this.#t=new MediaRecorder(this.#i),this.#e=[];let e=!1;this.#t.addEventListener("dataavailable",i=>{this.#e.push(i.data);let{restrictions:s}=this.uppy.opts;if(this.#e.length>1&&s.maxFileSize!=null&&!e){let r=this.#e.reduce((d,c)=>d+c.size,0),a=(r-this.#e[0].size)/(this.#e.length-1)*3,l=Math.max(0,s.maxFileSize-a);r>l&&(e=!0,this.uppy.info(this.i18n("recordingStoppedMaxSize"),"warning",4e3),this.#l())}}),this.#t.start(500),this.#o=setInterval(()=>{let i=this.getPluginState().recordingLengthSeconds;this.setPluginState({recordingLengthSeconds:i+1})},1e3),this.setPluginState({isRecording:!0})};#l=()=>new Promise(i=>{this.#t.addEventListener("stop",()=>{i()}),this.#t.stop(),clearInterval(this.#o),this.setPluginState({recordingLengthSeconds:0})}).then(()=>(this.setPluginState({isRecording:!1}),this.#f())).then(i=>{try{this.#r=i,this.setPluginState({recordedAudio:URL.createObjectURL(i.data)})}catch(s){s.isRestriction||this.uppy.log(s)}}).then(()=>{this.#e=null,this.#t=null},i=>{throw this.#e=null,this.#t=null,i});#m=()=>{this.setPluginState({recordedAudio:null}),this.#r=null};#g=()=>{try{this.#r&&this.uppy.addFile(this.#r)}catch(e){e.isRestriction||this.uppy.log(e,"warning")}};#n=async()=>{this.#i&&this.#i.getAudioTracks().forEach(i=>i.stop()),this.#t&&await new Promise(e=>{this.#t.addEventListener("stop",e,{once:!0}),this.#t.stop(),clearInterval(this.#o)}),this.#e=null,this.#t=null,this.#a=!1,this.#i=null,this.setPluginState({recordedAudio:null,isRecording:!1,recordingLengthSeconds:0})};#f(){let e=this.#e.find(a=>a.type?.length>0).type,i=L(e);if(!i)return Promise.reject(new Error(`Could not retrieve recording: Unsupported media type "${e}"`));let s=`audio-${Date.now()}.${i}`,r=new Blob(this.#e,{type:e}),n={source:this.id,name:s,data:new Blob([r],{type:e}),type:e};return Promise.resolve(n)}#y=e=>{this.#n(),this.#c({deviceId:e})};#d=()=>{this.#s.enumerateDevices().then(e=>{this.setPluginState({audioSources:e.filter(i=>i.kind==="audioinput")})})};render(){this.#a||this.#c();let e=this.getPluginState();return!e.audioReady||!e.hasAudio?t(P,{icon:this.icon,i18n:this.i18n,hasAudio:e.hasAudio}):t(b,{...e,onChangeSource:this.#y,onStartRecording:this.#p,onStopRecording:this.#l,onDiscardRecordedAudio:this.#m,onSubmit:this.#g,onStop:this.#n,i18n:this.i18n,showAudioSourceDropdown:this.opts.showAudioSourceDropdown,supportsRecording:w(),recording:e.isRecording,stream:this.#i})}install(){this.setPluginState({audioReady:!1,recordingLengthSeconds:0});let{target:e}=this.opts;e&&this.mount(e,this),this.#s&&(this.#d(),this.#s.ondevicechange=()=>{if(this.#d(),this.#i){let i=!0,{audioSources:s,currentDeviceId:r}=this.getPluginState();s.forEach(n=>{r===n.deviceId&&(i=!1)}),i&&(this.#n(),this.#c())}})}uninstall(){this.#i&&this.#n(),this.unmount()}};export{f as default};
//# sourceMappingURL=audio.js.map
