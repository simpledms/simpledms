import{q as he}from"../chunk-7MEJP3IB.js";import"../chunk-FW4363Y4.js";function R(r,e){if(!{}.hasOwnProperty.call(r,e))throw new TypeError("attempted to use private field on non-instance");return r}var Pe=0;function ce(r){return"__private_"+Pe+++"_"+r}var h=ce("uppy"),I=ce("events"),W=class{constructor(e){Object.defineProperty(this,h,{writable:!0,value:void 0}),Object.defineProperty(this,I,{writable:!0,value:[]}),R(this,h)[h]=e}on(e,t){return R(this,I)[I].push([e,t]),R(this,h)[h].on(e,t)}remove(){for(let[e,t]of R(this,I)[I].splice(0))R(this,h)[h].off(e,t)}onFilePause(e,t){this.on("upload-pause",(i,s)=>{e===i?.id&&t(s)})}onFileRemove(e,t){this.on("file-removed",i=>{e===i.id&&t(i.id)})}onPause(e,t){this.on("upload-pause",(i,s)=>{e===i?.id&&t(s)})}onRetry(e,t){this.on("upload-retry",i=>{e===i?.id&&t()})}onRetryAll(e,t){this.on("retry-all",()=>{R(this,h)[h].getFile(e)&&t()})}onPauseAll(e,t){this.on("pause-all",()=>{R(this,h)[h].getFile(e)&&t()})}onCancelAll(e,t){var i=this;this.on("cancel-all",function(){R(i,h)[h].getFile(e)&&t(...arguments)})}onResumeAll(e,t){this.on("resume-all",()=>{R(this,h)[h].getFile(e)&&t()})}};function o(r,e){if(!{}.hasOwnProperty.call(r,e))throw new TypeError("attempted to use private field on non-instance");return r}var Oe=0;function m(r){return"__private_"+Oe+++"_"+r}function _e(r){return new Error("Cancelled",{cause:r})}function fe(r){if(r!=null){var e;let t=()=>this.abort(r.reason);r.addEventListener("abort",t,{once:!0});let i=()=>{r.removeEventListener("abort",t)};(e=this.then)==null||e.call(this,i,i)}return this}var w=m("activeRequests"),f=m("queuedHandlers"),b=m("paused"),A=m("pauseTimer"),c=m("downLimit"),N=m("upperLimit"),x=m("rateLimitingTimer"),z=m("call"),j=m("queueNext"),ie=m("next"),te=m("queue"),se=m("dequeue"),re=m("resume"),M=m("increaseLimit"),Q=class{constructor(e){Object.defineProperty(this,se,{value:xe}),Object.defineProperty(this,te,{value:Re}),Object.defineProperty(this,ie,{value:qe}),Object.defineProperty(this,j,{value:Ee}),Object.defineProperty(this,z,{value:Te}),Object.defineProperty(this,w,{writable:!0,value:0}),Object.defineProperty(this,f,{writable:!0,value:[]}),Object.defineProperty(this,b,{writable:!0,value:!1}),Object.defineProperty(this,A,{writable:!0,value:void 0}),Object.defineProperty(this,c,{writable:!0,value:1}),Object.defineProperty(this,N,{writable:!0,value:void 0}),Object.defineProperty(this,x,{writable:!0,value:void 0}),Object.defineProperty(this,re,{writable:!0,value:()=>this.resume()}),Object.defineProperty(this,M,{writable:!0,value:()=>{if(o(this,b)[b]){o(this,x)[x]=setTimeout(o(this,M)[M],0);return}o(this,c)[c]=this.limit,this.limit=Math.ceil((o(this,N)[N]+o(this,c)[c])/2);for(let t=o(this,c)[c];t<=this.limit;t++)o(this,j)[j]();o(this,N)[N]-o(this,c)[c]>3?o(this,x)[x]=setTimeout(o(this,M)[M],2e3):o(this,c)[c]=Math.floor(o(this,c)[c]/2)}}),typeof e!="number"||e===0?this.limit=1/0:this.limit=e}run(e,t){return!o(this,b)[b]&&o(this,w)[w]<this.limit?o(this,z)[z](e):o(this,te)[te](e,t)}wrapSyncFunction(e,t){var i=this;return function(){for(var s=arguments.length,n=new Array(s),a=0;a<s;a++)n[a]=arguments[a];let l=i.run(()=>(e(...n),queueMicrotask(()=>l.done()),()=>{}),t);return{abortOn:fe,abort(){l.abort()}}}}wrapPromiseFunction(e,t){var i=this;return function(){for(var s=arguments.length,n=new Array(s),a=0;a<s;a++)n[a]=arguments[a];let l,_=new Promise((S,T)=>{l=i.run(()=>{let d,p;try{p=Promise.resolve(e(...n))}catch(v){p=Promise.reject(v)}return p.then(v=>{d?T(d):(l.done(),S(v))},v=>{d?T(d):(l.done(),T(v))}),v=>{d=_e(v)}},t)});return _.abort=S=>{l.abort(S)},_.abortOn=fe,_}}resume(){o(this,b)[b]=!1,clearTimeout(o(this,A)[A]);for(let e=0;e<this.limit;e++)o(this,j)[j]()}pause(e){e===void 0&&(e=null),o(this,b)[b]=!0,clearTimeout(o(this,A)[A]),e!=null&&(o(this,A)[A]=setTimeout(o(this,re)[re],e))}rateLimit(e){clearTimeout(o(this,x)[x]),this.pause(e),this.limit>1&&Number.isFinite(this.limit)&&(o(this,N)[N]=this.limit-1,this.limit=o(this,c)[c],o(this,x)[x]=setTimeout(o(this,M)[M],e))}get isPaused(){return o(this,b)[b]}};function Te(r){o(this,w)[w]+=1;let e=!1,t;try{t=r()}catch(i){throw o(this,w)[w]-=1,i}return{abort:i=>{e||(e=!0,o(this,w)[w]-=1,t?.(i),o(this,j)[j]())},done:()=>{e||(e=!0,o(this,w)[w]-=1,o(this,j)[j]())}}}function Ee(){queueMicrotask(()=>o(this,ie)[ie]())}function qe(){if(o(this,b)[b]||o(this,w)[w]>=this.limit||o(this,f)[f].length===0)return;let r=o(this,f)[f].shift();if(r==null)throw new Error("Invariant violation: next is null");let e=o(this,z)[z](r.fn);r.abort=e.abort,r.done=e.done}function Re(r,e){let t={fn:r,priority:e?.priority||0,abort:()=>{o(this,se)[se](t)},done:()=>{throw new Error("Cannot mark a queued request as done: this indicates a bug")}},i=o(this,f)[f].findIndex(s=>t.priority>s.priority);return i===-1?o(this,f)[f].push(t):o(this,f)[f].splice(i,0,t),t}function xe(r){let e=o(this,f)[f].indexOf(r);e!==-1&&o(this,f)[f].splice(e,1)}var $=Symbol("__queue");var oe=class extends Error{constructor(e,t){t===void 0&&(t=null),super("This looks like a network error, the endpoint might be blocked by an internet provider or a firewall."),this.cause=e,this.isNetworkError=!0,this.request=t}},J=oe;function je(r){return r?r.readyState!==0&&r.readyState!==4||r.status===0:!1}var me=je;function F(r,e){if(!{}.hasOwnProperty.call(r,e))throw new TypeError("attempted to use private field on non-instance");return r}var Ue=0;function G(r){return"__private_"+Ue+++"_"+r}var U=G("aliveTimer"),B=G("isDone"),K=G("onTimedOut"),C=G("timeout"),ne=class{constructor(e,t){Object.defineProperty(this,U,{writable:!0,value:void 0}),Object.defineProperty(this,B,{writable:!0,value:!1}),Object.defineProperty(this,K,{writable:!0,value:void 0}),Object.defineProperty(this,C,{writable:!0,value:void 0}),F(this,C)[C]=e,F(this,K)[K]=()=>t(e)}progress(){F(this,B)[B]||F(this,C)[C]>0&&(clearTimeout(F(this,U)[U]),F(this,U)[U]=setTimeout(F(this,K)[K],F(this,C)[C]))}done(){F(this,B)[B]||(clearTimeout(F(this,U)[U]),F(this,U)[U]=void 0,F(this,B)[B]=!0)}},ve=ne;var V=()=>{};function ye(r,e){e===void 0&&(e={});let{body:t=null,headers:i={},method:s="GET",onBeforeRequest:n=V,onUploadProgress:a=V,shouldRetry:l=()=>!0,onAfterResponse:_=V,onTimeout:S=V,responseType:T,retries:d=3,signal:p=null,timeout:v=3e4,withCredentials:y=!1}=e,E=g=>.3*2**(g-1)*1e3,P=new ve(v,S);function O(g){return g===void 0&&(g=0),new Promise(async(ee,H)=>{let u=new XMLHttpRequest,pe=q=>{l(u)&&g<d?setTimeout(()=>{O(g+1).then(ee,H)},E(g)):(P.done(),H(q))};u.open(s,r,!0),u.withCredentials=y,T&&(u.responseType=T),p?.addEventListener("abort",()=>{u.abort(),H(new DOMException("Aborted","AbortError"))}),u.onload=async()=>{try{await _(u,g)}catch(q){q.request=u,pe(q);return}u.status>=200&&u.status<300?(P.done(),ee(u)):l(u)&&g<d?setTimeout(()=>{O(g+1).then(ee,H)},E(g)):(P.done(),H(new J(u.statusText,u)))},u.onerror=()=>pe(new J(u.statusText,u)),u.upload.onprogress=q=>{P.progress(),a(q)},i&&Object.keys(i).forEach(q=>{u.setRequestHeader(q,i[q])}),await n(u,g),u.send(t)})}return O()}function be(r){let e=t=>"error"in t&&!!t.error;return r.filter(t=>!e(t))}function we(r){return r.filter(e=>{var t;return!((t=e.progress)!=null&&t.uploadStarted)||!e.isRestored})}function Y(r,e){return r===!0?Object.keys(e):Array.isArray(r)?r:[]}var ge={strings:{uploadStalled:"Upload has not made any progress for %{seconds} seconds. You may want to retry it."}};function L(r,e){if(!{}.hasOwnProperty.call(r,e))throw new TypeError("attempted to use private field on non-instance");return r}var Le=0;function k(r){return"__private_"+Le+++"_"+r}var Se={version:"4.3.3"};function Ae(r,e){let t=e;return t||(t=new Error("Upload error")),typeof t=="string"&&(t=new Error(t)),t instanceof Error||(t=Object.assign(new Error("Upload error"),{data:t})),me(r)?(t=new J(t,r),t):(t.request=r,t)}function Fe(r){return r.data.slice(0,r.data.size,r.meta.type)}var Ne={formData:!0,fieldName:"file",method:"post",allowedMetaFields:!0,bundle:!1,headers:{},timeout:30*1e3,limit:5,withCredentials:!1,responseType:""},D=k("getFetcher"),ue=k("uploadLocalFile"),ae=k("uploadBundle"),de=k("getCompanionClientArgs"),le=k("uploadFiles"),X=k("handleUpload"),Z=class extends he{constructor(e,t){if(super(e,{...Ne,fieldName:t.bundle?"files[]":"file",...t}),Object.defineProperty(this,le,{value:De}),Object.defineProperty(this,de,{value:Ce}),Object.defineProperty(this,ae,{value:Be}),Object.defineProperty(this,ue,{value:Me}),Object.defineProperty(this,D,{writable:!0,value:void 0}),Object.defineProperty(this,X,{writable:!0,value:async i=>{if(i.length===0){this.uppy.log("[XHRUpload] No files to upload!");return}this.opts.limit===0&&!this.opts[$]&&this.uppy.log("[XHRUpload] When uploading multiple files at once, consider setting the `limit` option (to `10` for example), to limit the number of concurrent uploads, which helps prevent memory and network issues: https://uppy.io/docs/xhr-upload/#limit-0","warning"),this.uppy.log("[XHRUpload] Uploading...");let s=this.uppy.getFilesByIds(i),n=be(s),a=we(n);if(this.uppy.emit("upload-start",a),this.opts.bundle){if(n.some(_=>_.isRemote))throw new Error("Can\u2019t upload remote files when the `bundle: true` option is set");if(typeof this.opts.headers=="function")throw new TypeError("`headers` may not be a function when the `bundle: true` option is set");await L(this,ae)[ae](n)}else await L(this,le)[le](n)}}),this.type="uploader",this.id=this.opts.id||"XHRUpload",this.defaultLocale=ge,this.i18nInit(),$ in this.opts?this.requests=this.opts[$]:this.requests=new Q(this.opts.limit),this.opts.bundle&&!this.opts.formData)throw new Error("`opts.formData` must be true when `opts.bundle` is enabled.");if(this.opts.bundle&&typeof this.opts.headers=="function")throw new Error("`opts.headers` can not be a function when the `bundle: true` option is set.");if(t?.allowedMetaFields===void 0&&"metaFields"in this.opts)throw new Error("The `metaFields` option has been renamed to `allowedMetaFields`.");this.uploaderEvents=Object.create(null),L(this,D)[D]=i=>async(s,n)=>{try{var a,l,_;let d=await ye(s,{...n,onBeforeRequest:(y,E)=>{var P,O;return(P=(O=this.opts).onBeforeRequest)==null?void 0:P.call(O,y,E,i)},shouldRetry:this.opts.shouldRetry,onAfterResponse:this.opts.onAfterResponse,onTimeout:y=>{let E=Math.ceil(y/1e3),P=new Error(this.i18n("uploadStalled",{seconds:E}));this.uppy.emit("upload-stalled",P,i)},onUploadProgress:y=>{if(y.lengthComputable)for(let{id:P}of i){var E;let O=this.uppy.getFile(P);this.uppy.emit("upload-progress",O,{uploadStarted:(E=O.progress.uploadStarted)!=null?E:0,bytesUploaded:y.loaded/y.total*O.size,bytesTotal:O.size})}}}),p=await((a=(l=this.opts).getResponseData)==null?void 0:a.call(l,d));if(d.responseType==="json"){var S;(S=p)!=null||(p=d.response)}else try{var T;(T=p)!=null||(p=JSON.parse(d.responseText))}catch(y){throw new Error("@uppy/xhr-upload expects a JSON response (with a `url` property). To parse non-JSON responses, use `getResponseData` to turn your response into JSON.",{cause:y})}let v=typeof((_=p)==null?void 0:_.url)=="string"?p.url:void 0;for(let{id:y}of i)this.uppy.emit("upload-success",this.uppy.getFile(y),{status:d.status,body:p,uploadURL:v});return d}catch(d){if(d.name==="AbortError")return;let p=d.request;for(let v of i)this.uppy.emit("upload-error",this.uppy.getFile(v.id),Ae(p,d),p);throw d}}}getOptions(e){let t=this.uppy.getState().xhrUpload,{headers:i}=this.opts,s={...this.opts,...t||{},...e.xhrUpload||{},headers:{}};return typeof i=="function"?s.headers=i(e):Object.assign(s.headers,this.opts.headers),t&&Object.assign(s.headers,t.headers),e.xhrUpload&&Object.assign(s.headers,e.xhrUpload.headers),s}addMetadata(e,t,i){Y(i.allowedMetaFields,t).forEach(n=>{let a=t[n];Array.isArray(a)?a.forEach(l=>e.append(n,l)):e.append(n,a)})}createFormDataUpload(e,t){let i=new FormData;this.addMetadata(i,e.meta,t);let s=Fe(e);return e.name?i.append(t.fieldName,s,e.meta.name):i.append(t.fieldName,s),i}createBundledUpload(e,t){let i=new FormData,{meta:s}=this.uppy.getState();return this.addMetadata(i,s,t),e.forEach(n=>{let a=this.getOptions(n),l=Fe(n);n.name?i.append(a.fieldName,l,n.name):i.append(a.fieldName,l)}),i}install(){if(this.opts.bundle){let{capabilities:e}=this.uppy.getState();this.uppy.setState({capabilities:{...e,individualCancellation:!1}})}this.uppy.addUploader(L(this,X)[X])}uninstall(){if(this.opts.bundle){let{capabilities:e}=this.uppy.getState();this.uppy.setState({capabilities:{...e,individualCancellation:!0}})}this.uppy.removeUploader(L(this,X)[X])}};async function Me(r){let e=new W(this.uppy),t=new AbortController,i=this.requests.wrapPromiseFunction(async()=>{let s=this.getOptions(r),n=L(this,D)[D]([r]),a=s.formData?this.createFormDataUpload(r,s):r.data;return n(s.endpoint,{...s,body:a,signal:t.signal})});e.onFileRemove(r.id,()=>t.abort()),e.onCancelAll(r.id,()=>{t.abort()});try{await i().abortOn(t.signal)}catch(s){if(s.message!=="Cancelled")throw s}finally{e.remove()}}async function Be(r){let e=new AbortController,t=this.requests.wrapPromiseFunction(async()=>{var s;let n=(s=this.uppy.getState().xhrUpload)!=null?s:{},a=L(this,D)[D](r),l=this.createBundledUpload(r,{...this.opts,...n});return a(this.opts.endpoint,{...this.opts,body:l,signal:e.signal})});function i(){e.abort()}this.uppy.once("cancel-all",i);try{await t().abortOn(e.signal)}catch(s){if(s.message!=="Cancelled")throw s}finally{this.uppy.off("cancel-all",i)}}function Ce(r){var e;let t=this.getOptions(r),i=Y(t.allowedMetaFields,r.meta);return{...(e=r.remote)==null?void 0:e.body,protocol:"multipart",endpoint:t.endpoint,size:r.data.size,fieldname:t.fieldName,metadata:Object.fromEntries(i.map(s=>[s,r.meta[s]])),httpMethod:t.method,useFormData:t.formData,headers:t.headers}}async function De(r){await Promise.allSettled(r.map(e=>{if(e.isRemote){let t=()=>this.requests,i=new AbortController,s=a=>{a.id===e.id&&i.abort()};this.uppy.on("file-removed",s);let n=this.uppy.getRequestClientForFile(e).uploadRemoteFile(e,L(this,de)[de](e),{signal:i.signal,getQueue:t});return this.requests.wrapSyncFunction(()=>{this.uppy.off("file-removed",s)},{priority:-1})(),n}return L(this,ue)[ue](e)}))}Z.VERSION=Se.version;export{Z as default};
//# sourceMappingURL=xhr-upload.js.map
