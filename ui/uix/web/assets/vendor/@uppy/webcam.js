import{a as g}from"../chunk-X4UV3AIF.js";import{a as i}from"../chunk-CLGSKES3.js";import{i as V,q as N,s as B}from"../chunk-RMJY7HHF.js";import{a as ie,b as se}from"../chunk-FW4363Y4.js";var E=ie((me,f)=>{"use strict";f.exports=R;f.exports.isMobile=R;f.exports.default=R;var oe=/(android|bb\d+|meego).+mobile|armv7l|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series[46]0|samsungbrowser.*mobile|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i,re=/CrOS/,ne=/android|ipad|playbook|silk/i;function R(o){o||(o={});let e=o.ua;if(!e&&typeof navigator<"u"&&(e=navigator.userAgent),e&&e.headers&&typeof e.headers["user-agent"]=="string"&&(e=e.headers["user-agent"]),typeof e!="string")return!1;let t=oe.test(e)&&!re.test(e)||!!o.tablet&&ne.test(e);return!t&&o.tablet&&o.featureDetect&&navigator&&navigator.maxTouchPoints>1&&e.indexOf("Macintosh")!==-1&&e.indexOf("Safari")!==-1&&(t=!0),t}});function w(o,e,t){return new Promise(s=>{o.toBlob(s,e,t)})}var _=se(E(),1);var W={name:"@uppy/webcam",description:"Uppy plugin that takes photos or records videos using the device's camera.",version:"4.3.2",license:"MIT",main:"lib/index.js",style:"dist/style.min.css",type:"module",scripts:{build:"tsc --build tsconfig.build.json","build:css":"sass --load-path=../../ src/style.scss dist/style.css && postcss dist/style.css -u cssnano -o dist/style.min.css",typecheck:"tsc --build",test:"vitest run --environment=jsdom --silent='passed-only'"},keywords:["file uploader","uppy","uppy-plugin","webcam","picture","photo","video","record","mediarecorder"],homepage:"https://uppy.io",bugs:{url:"https://github.com/transloadit/uppy/issues"},repository:{type:"git",url:"git+https://github.com/transloadit/uppy.git"},files:["src","lib","dist","CHANGELOG.md"],dependencies:{"@uppy/utils":"^6.2.2","is-mobile":"^4.0.0",preact:"^10.5.13"},devDependencies:{cssnano:"^7.0.7",jsdom:"^26.1.0",postcss:"^8.5.6","postcss-cli":"^11.0.1",sass:"^1.89.2",typescript:"^5.8.3",vitest:"^3.2.4"},peerDependencies:{"@uppy/core":"^4.5.2"}};function h(){return i("svg",{"aria-hidden":"true",focusable:"false",fill:"#0097DC",width:"66",height:"55",viewBox:"0 0 66 55",children:i("path",{d:"M57.3 8.433c4.59 0 8.1 3.51 8.1 8.1v29.7c0 4.59-3.51 8.1-8.1 8.1H8.7c-4.59 0-8.1-3.51-8.1-8.1v-29.7c0-4.59 3.51-8.1 8.1-8.1h9.45l4.59-7.02c.54-.54 1.35-1.08 2.16-1.08h16.2c.81 0 1.62.54 2.16 1.08l4.59 7.02h9.45zM33 14.64c-8.62 0-15.393 6.773-15.393 15.393 0 8.62 6.773 15.393 15.393 15.393 8.62 0 15.393-6.773 15.393-15.393 0-8.62-6.773-15.393-15.393-15.393zM33 40c-5.648 0-9.966-4.319-9.966-9.967 0-5.647 4.318-9.966 9.966-9.966s9.966 4.319 9.966 9.966C42.966 35.681 38.648 40 33 40z",fillRule:"evenodd"})})}function ce({onDiscard:o,i18n:e}){return i("button",{className:"uppy-u-reset uppy-c-btn uppy-Webcam-button uppy-Webcam-button--discard",type:"button",title:e("discardRecordedFile"),"aria-label":e("discardRecordedFile"),onClick:o,"data-uppy-super-focusable":!0,children:i("svg",{width:"13",height:"13",viewBox:"0 0 13 13",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",className:"uppy-c-icon",children:i("g",{fill:"#FFF",fillRule:"evenodd",children:[i("path",{d:"M.496 11.367L11.103.76l1.414 1.414L1.911 12.781z"}),i("path",{d:"M11.104 12.782L.497 2.175 1.911.76l10.607 10.606z"})]})})})}var F=ce;function x({recording:o,onStartRecording:e,onStopRecording:t,i18n:s}){return o?i("button",{className:"uppy-u-reset uppy-c-btn uppy-Webcam-button",type:"button",title:s("stopRecording"),"aria-label":s("stopRecording"),onClick:t,"data-uppy-super-focusable":!0,children:i("svg",{"aria-hidden":"true",focusable:"false",className:"uppy-c-icon",width:"100",height:"100",viewBox:"0 0 100 100",children:i("rect",{x:"15",y:"15",width:"70",height:"70"})})}):i("button",{className:"uppy-u-reset uppy-c-btn uppy-Webcam-button",type:"button",title:s("startRecording"),"aria-label":s("startRecording"),onClick:e,"data-uppy-super-focusable":!0,children:i("svg",{"aria-hidden":"true",focusable:"false",className:"uppy-c-icon",width:"100",height:"100",viewBox:"0 0 100 100",children:i("circle",{cx:"50",cy:"50",r:"40"})})})}function C(o){return`${Math.floor(o/60)}:${String(o%60).padStart(2,"0")}`}function M({recordingLengthSeconds:o}){let e=C(o);return i("span",{children:e})}function k({onSnapshot:o,i18n:e}){return i("button",{className:"uppy-u-reset uppy-c-btn uppy-Webcam-button uppy-Webcam-button--picture",type:"button",title:e("takePicture"),"aria-label":e("takePicture"),onClick:o,"data-uppy-super-focusable":!0,children:h()})}function de({onSubmit:o,i18n:e}){return i("button",{className:"uppy-u-reset uppy-c-btn uppy-Webcam-button uppy-Webcam-button--submit",type:"button",title:e("submitRecordedFile"),"aria-label":e("submitRecordedFile"),onClick:o,"data-uppy-super-focusable":!0,children:i("svg",{width:"12",height:"9",viewBox:"0 0 12 9",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",className:"uppy-c-icon",children:i("path",{fill:"#fff",fillRule:"nonzero",d:"M10.66 0L12 1.31 4.136 9 0 4.956l1.34-1.31L4.136 6.38z"})})})}var O=de;function T({currentDeviceId:o,videoSources:e,onChangeVideoSource:t}){return i("div",{className:"uppy-Webcam-videoSource",children:i("select",{className:"uppy-u-reset uppy-Webcam-videoSource-select",onChange:s=>{t(s.target.value)},children:e.map(s=>i("option",{value:s.deviceId,selected:s.deviceId===o,children:s.label},s.deviceId))})})}function b(o,e){return o.includes(e)}var P=class extends V{videoElement;refs;componentDidMount(){let{onFocus:e}=this.props;e()}componentWillUnmount(){let{onStop:e}=this.props;e()}render(){let{src:e,recordedVideo:t,capturedSnapshot:s,recording:r,modes:n,supportsRecording:a,videoSources:c,showVideoSourceDropdown:d,showRecordingLength:l,onSubmit:v,i18n:u,mirror:H,onSnapshot:q,onStartRecording:G,onStopRecording:J,onDiscardRecordedMedia:K,recordingLengthSeconds:Q}=this.props,m=!!t,S=!!s,D=m||S,X=!D&&a&&(b(n,"video-only")||b(n,"audio-only")||b(n,"video-audio")),Y=!D&&b(n,"picture"),Z=a&&l&&!m,ee=d&&c&&c.length>1,p={playsInline:!0};return t?(p.muted=!1,p.controls=!0,p.src=t,this.videoElement&&(this.videoElement.srcObject=null)):(p.muted=!0,p.autoPlay=!0,p.srcObject=e),i("div",{className:"uppy uppy-Webcam-container",children:[i("div",{className:"uppy-Webcam-videoContainer",children:s&&!r&&!t?i("div",{className:"uppy-Webcam-imageContainer",children:i("img",{src:s,className:"uppy-Webcam-video",alt:"capturedSnapshot"})}):i("video",{ref:te=>this.videoElement=te,className:`uppy-Webcam-video  ${H?"uppy-Webcam-video--mirrored":""}`,...p})}),i("div",{className:"uppy-Webcam-footer",children:[i("div",{className:"uppy-Webcam-videoSourceContainer",children:ee?T(this.props):null}),i("div",{className:"uppy-Webcam-buttonContainer",children:[Y&&i(k,{onSnapshot:q,i18n:u}),X&&i(x,{recording:r,onStartRecording:G,onStopRecording:J,i18n:u}),(m||S)&&i(O,{onSubmit:v,i18n:u}),(m||S)&&i(F,{onDiscard:K,i18n:u})]}),i("div",{className:"uppy-Webcam-recordingLength",children:Z&&i(M,{recordingLengthSeconds:Q})})]})]})}},z=P;var A={strings:{pluginNameCamera:"Camera",noCameraTitle:"Camera Not Available",noCameraDescription:"In order to take pictures or record video, please connect a camera device",recordingStoppedMaxSize:"Recording stopped because the file size is about to exceed the limit",submitRecordedFile:"Submit recorded file",discardRecordedFile:"Discard recorded file",smile:"Smile!",takePicture:"Take a picture",startRecording:"Begin video recording",stopRecording:"Stop video recording",recordingLength:"Recording length %{recording_length}",allowAccessTitle:"Please allow access to your camera",allowAccessDescription:"In order to take pictures or record video with your camera, please allow camera access for this site."}};function L({icon:o,i18n:e,hasCamera:t}){return i("div",{className:"uppy-Webcam-permissons",children:[i("div",{className:"uppy-Webcam-permissonsIcon",children:o()}),i("div",{className:"uppy-Webcam-title",children:e(t?"allowAccessTitle":"noCameraTitle")}),i("p",{children:e(t?"allowAccessDescription":"noCameraDescription")})]})}function j(){return typeof MediaRecorder=="function"&&!!MediaRecorder.prototype&&typeof MediaRecorder.prototype.start=="function"}function U(o){return o[0]==="."?B[o.slice(1)]:o}function pe(o){return/^video\/[^*]+$/.test(o)}function ue(o){return/^image\/[^*]+$/.test(o)}function le(){return navigator.mediaDevices}function I(o,e){return o.includes(e)}var $={onBeforeSnapshot:()=>Promise.resolve(),countdown:!1,modes:["video-audio","video-only","audio-only","picture"],mirror:!0,showVideoSourceDropdown:!1,preferredImageMimeType:null,preferredVideoMimeType:null,showRecordingLength:!1,mobileNativeCamera:(0,_.isMobile)({tablet:!0})},y=class extends N{static VERSION=W.version;#e;mediaDevices;supportsUserMedia;protocol;capturedMediaFile;icon;webcamActive;stream=null;recorder=null;recordingChunks=null;recordingLengthTimer;captureInProgress=!1;constructor(e,t){super(e,{...$,...t}),this.mediaDevices=le(),this.supportsUserMedia=!!this.mediaDevices,this.protocol=location.protocol.match(/https/i)?"https":"http",this.id=this.opts.id||"Webcam",this.type="acquirer",this.capturedMediaFile=null,this.icon=()=>i("svg",{"aria-hidden":"true",focusable:"false",width:"32",height:"32",viewBox:"0 0 32 32",children:i("path",{d:"M23.5 9.5c1.417 0 2.5 1.083 2.5 2.5v9.167c0 1.416-1.083 2.5-2.5 2.5h-15c-1.417 0-2.5-1.084-2.5-2.5V12c0-1.417 1.083-2.5 2.5-2.5h2.917l1.416-2.167C13 7.167 13.25 7 13.5 7h5c.25 0 .5.167.667.333L20.583 9.5H23.5zM16 11.417a4.706 4.706 0 00-4.75 4.75 4.704 4.704 0 004.75 4.75 4.703 4.703 0 004.75-4.75c0-2.663-2.09-4.75-4.75-4.75zm0 7.825c-1.744 0-3.076-1.332-3.076-3.074 0-1.745 1.333-3.077 3.076-3.077 1.744 0 3.074 1.333 3.074 3.076s-1.33 3.075-3.074 3.075z",fill:"#02B383",fillRule:"nonzero"})}),this.defaultLocale=A,this.i18nInit(),this.title=this.i18n("pluginNameCamera"),this.#e=this.opts.mirror,this.install=this.install.bind(this),this.setPluginState=this.setPluginState.bind(this),this.render=this.render.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.takeSnapshot=this.takeSnapshot.bind(this),this.startRecording=this.startRecording.bind(this),this.stopRecording=this.stopRecording.bind(this),this.discardRecordedMedia=this.discardRecordedMedia.bind(this),this.submit=this.submit.bind(this),this.oneTwoThreeSmile=this.oneTwoThreeSmile.bind(this),this.focus=this.focus.bind(this),this.changeVideoSource=this.changeVideoSource.bind(this),this.webcamActive=!1,this.opts.countdown&&(this.opts.onBeforeSnapshot=this.oneTwoThreeSmile),this.setPluginState({hasCamera:!1,cameraReady:!1,cameraError:null,recordingLengthSeconds:0,videoSources:[],currentDeviceId:null,capturedSnapshot:null})}getStatus(){let{recordedVideo:e,capturedSnapshot:t,isRecording:s,cameraReady:r,cameraError:n}=this.getPluginState();return s?"recording":e!=null||t!=null?"captured":r?"ready":n?"error":"init"}setOptions(e){super.setOptions({...e,videoConstraints:{...this.opts.videoConstraints,...e?.videoConstraints}})}hasCameraCheck(){return this.mediaDevices?this.mediaDevices.enumerateDevices().then(e=>e.some(t=>t.kind==="videoinput")):Promise.resolve(!1)}isAudioOnly(){return this.opts.modes.length===1&&this.opts.modes[0]==="audio-only"}getConstraints(e=null){let t=this.opts.modes.indexOf("video-audio")!==-1||this.opts.modes.indexOf("audio-only")!==-1,s=!this.isAudioOnly()&&(this.opts.modes.indexOf("video-audio")!==-1||this.opts.modes.indexOf("video-only")!==-1||this.opts.modes.indexOf("picture")!==-1),r={...this.opts.videoConstraints||{},...e!=null&&{deviceId:e}};return{audio:t,video:s?r:!1}}start(e=null){if(!this.supportsUserMedia)return Promise.reject(new Error("Webcam access not supported"));this.webcamActive=!0,this.opts.mirror&&(this.#e=!0);let t=this.getConstraints(e?.deviceId);this.hasCameraCheck().then(s=>(this.setPluginState({hasCamera:s}),this.mediaDevices.getUserMedia(t).then(r=>{this.stream=r;let n=null,a=this.isAudioOnly()?r.getAudioTracks():r.getVideoTracks();!e||!e.deviceId?n=a[0].getSettings().deviceId:a.forEach(c=>{c.getSettings().deviceId===e.deviceId&&(n=c.getSettings().deviceId)}),this.updateVideoSources(),this.setPluginState({currentDeviceId:n,cameraReady:!0})}).catch(r=>{this.setPluginState({cameraReady:!1,cameraError:r}),this.uppy.info(r.message,"error")})))}getMediaRecorderOptions(){let e={};if(MediaRecorder.isTypeSupported){let{restrictions:t}=this.uppy.opts,s=[];this.opts.preferredVideoMimeType?s=[this.opts.preferredVideoMimeType]:t.allowedFileTypes&&(s=t.allowedFileTypes.map(U).filter(pe));let r=a=>MediaRecorder.isTypeSupported(a)&&g(a),n=s.filter(r);n.length>0&&(e.mimeType=n[0])}return e}startRecording(){this.recorder=new MediaRecorder(this.stream,this.getMediaRecorderOptions()),this.recordingChunks=[];let e=!1;this.recorder.addEventListener("dataavailable",t=>{this.recordingChunks.push(t.data);let{restrictions:s}=this.uppy.opts;if(this.recordingChunks.length>1&&s.maxFileSize!=null&&!e){let r=this.recordingChunks.reduce((d,l)=>d+l.size,0),a=(r-this.recordingChunks[0].size)/(this.recordingChunks.length-1)*3,c=Math.max(0,s.maxFileSize-a);r>c&&(e=!0,this.uppy.info(this.i18n("recordingStoppedMaxSize"),"warning",4e3),this.stopRecording())}}),this.recorder.start(500),this.opts.showRecordingLength&&(this.recordingLengthTimer=setInterval(()=>{let t=this.getPluginState().recordingLengthSeconds;this.setPluginState({recordingLengthSeconds:t+1})},1e3)),this.setPluginState({isRecording:!0})}stopRecording(){return new Promise(t=>{this.recorder.addEventListener("stop",()=>{t()}),this.recorder.stop(),this.opts.showRecordingLength&&(clearInterval(this.recordingLengthTimer),this.setPluginState({recordingLengthSeconds:0}))}).then(()=>(this.setPluginState({isRecording:!1}),this.getVideo())).then(t=>{try{this.capturedMediaFile=t,this.setPluginState({recordedVideo:URL.createObjectURL(t.data)}),this.#e=!1}catch(s){s.isRestriction||this.uppy.log(s)}}).then(()=>{this.recordingChunks=null,this.recorder=null},t=>{throw this.recordingChunks=null,this.recorder=null,t})}discardRecordedMedia(){let{recordedVideo:e,capturedSnapshot:t}=this.getPluginState();e&&URL.revokeObjectURL(e),t&&URL.revokeObjectURL(t),this.setPluginState({recordedVideo:null,capturedSnapshot:null}),this.opts.mirror&&(this.#e=!0),this.capturedMediaFile=null}submit(){try{this.capturedMediaFile&&this.uppy.addFile(this.capturedMediaFile)}catch(e){e.isRestriction||this.uppy.log(e,"error")}}async stop(){if(this.stream){let e=this.stream.getAudioTracks(),t=this.stream.getVideoTracks();e.concat(t).forEach(s=>s.stop())}this.recorder&&await new Promise(e=>{this.recorder.addEventListener("stop",e,{once:!0}),this.recorder.stop(),this.opts.showRecordingLength&&clearInterval(this.recordingLengthTimer)}),this.recordingChunks=null,this.recorder=null,this.webcamActive=!1,this.stream=null,this.setPluginState({recordedVideo:null,capturedSnapshot:null,isRecording:!1,recordingLengthSeconds:0})}getVideoElement(){return this.el.querySelector(".uppy-Webcam-video")}oneTwoThreeSmile(){return new Promise((e,t)=>{let s=this.opts.countdown,r=setInterval(()=>{if(!this.webcamActive)return clearInterval(r),this.captureInProgress=!1,t(new Error("Webcam is not active"));s?(this.uppy.info(`${s}...`,"warning",800),s--):(clearInterval(r),this.uppy.info(this.i18n("smile"),"success",1500),setTimeout(()=>e(),1500))},1e3)})}async takeSnapshot(){if(!this.captureInProgress){this.captureInProgress=!0;try{await this.opts.onBeforeSnapshot()}catch(e){let t=typeof e=="object"?e.message:e;throw this.uppy.info(t,"error",5e3),new Error(`onBeforeSnapshot: ${t}`)}try{let e=await this.getImage();this.capturedMediaFile=e;let t=URL.createObjectURL(e.data);this.setPluginState({capturedSnapshot:t}),this.captureInProgress=!1}catch(e){this.captureInProgress=!1,e.isRestriction||this.uppy.log(e)}}}getImage(){let e=this.getVideoElement();if(!e)return Promise.reject(new Error("No video element found, likely due to the Webcam tab being closed."));let t=e.videoWidth,s=e.videoHeight,r=document.createElement("canvas");r.width=t,r.height=s,r.getContext("2d").drawImage(e,0,0);let{restrictions:a}=this.uppy.opts,c=[];this.opts.preferredImageMimeType?c=[this.opts.preferredImageMimeType]:a.allowedFileTypes&&(c=a.allowedFileTypes.map(U).filter(ue));let d=c[0]||"image/jpeg",l=g(d)||"jpg",v=`cam-${Date.now()}.${l}`;return w(r,d).then(u=>({source:this.id,name:v,data:new Blob([u],{type:d}),type:d}))}getVideo(){let e=this.recordingChunks.find(a=>a.type?.length>0).type,t=g(e);if(!t)return Promise.reject(new Error(`Could not retrieve recording: Unsupported media type "${e}"`));let s=`webcam-${Date.now()}.${t}`,r=new Blob(this.recordingChunks,{type:e}),n={source:this.id,name:s,data:new Blob([r],{type:e}),type:e};return Promise.resolve(n)}focus(){this.opts.countdown&&setTimeout(()=>{this.uppy.info(this.i18n("smile"),"success",1500)},1e3)}changeVideoSource(e){this.stop(),this.start({deviceId:e})}updateVideoSources(){this.mediaDevices.enumerateDevices().then(e=>{this.setPluginState({videoSources:e.filter(t=>t.kind==="videoinput")})})}render(){this.webcamActive||this.start();let e=this.getPluginState();return!e.cameraReady||!e.hasCamera?i(L,{icon:h,i18n:this.i18n,hasCamera:e.hasCamera}):i(z,{...e,onChangeVideoSource:this.changeVideoSource,onSnapshot:this.takeSnapshot,onStartRecording:this.startRecording,onStopRecording:this.stopRecording,onDiscardRecordedMedia:this.discardRecordedMedia,onSubmit:this.submit,onFocus:this.focus,onStop:this.stop,i18n:this.i18n,modes:this.opts.modes,showRecordingLength:this.opts.showRecordingLength,showVideoSourceDropdown:this.opts.showVideoSourceDropdown,supportsRecording:j(),recording:e.isRecording,mirror:this.#e,src:this.stream})}install(){let{mobileNativeCamera:e,modes:t,videoConstraints:s}=this.opts,{target:r}=this.opts;if(e&&r){this.getTargetPlugin(r)?.setOptions({showNativeVideoCameraButton:I(t,"video-only")||I(t,"video-audio"),showNativePhotoCameraButton:I(t,"picture"),nativeCameraFacingMode:s?.facingMode});return}this.setPluginState({cameraReady:!1,recordingLengthSeconds:0}),r&&this.mount(r,this),this.mediaDevices&&(this.updateVideoSources(),this.mediaDevices.ondevicechange=()=>{if(this.updateVideoSources(),this.stream){let n=!0,{videoSources:a,currentDeviceId:c}=this.getPluginState();a.forEach(d=>{c===d.deviceId&&(n=!1)}),n&&(this.stop(),this.start())}})}uninstall(){this.stop(),this.unmount()}onUnmount(){this.stop()}};export{y as default,$ as defaultOptions};
//# sourceMappingURL=webcam.js.map
