import{a as l}from"../chunk-X4UV3AIF.js";import{a as t}from"../chunk-CLGSKES3.js";import{h as m,i as d,q as R}from"../chunk-RMJY7HHF.js";import"../chunk-FW4363Y4.js";var M={name:"@uppy/screen-capture",description:"Uppy plugin that captures video from display or application.",version:"4.4.2",license:"MIT",main:"lib/index.js",style:"dist/style.min.css",type:"module",scripts:{build:"tsc --build tsconfig.build.json","build:css":"sass --load-path=../../ src/style.scss dist/style.css && postcss dist/style.css -u cssnano -o dist/style.min.css",typecheck:"tsc --build"},keywords:["file uploader","uppy","uppy-plugin","screen capture","video","record","mediarecorder"],homepage:"https://uppy.io",bugs:{url:"https://github.com/transloadit/uppy/issues"},repository:{type:"git",url:"git+https://github.com/transloadit/uppy.git"},files:["src","lib","dist","CHANGELOG.md"],dependencies:{"@uppy/utils":"^6.2.2",preact:"^10.5.13"},peerDependencies:{"@uppy/core":"^4.5.2"},publishConfig:{access:"public"},devDependencies:{cssnano:"^7.0.7",postcss:"^8.5.6","postcss-cli":"^11.0.1",sass:"^1.89.2",typescript:"^5.8.3"}};var j={strings:{pluginNameScreenCapture:"Screencast",startCapturing:"Begin screen capturing",stopCapturing:"Stop screen capturing",submitRecordedFile:"Submit recorded file",streamActive:"Stream active",streamPassive:"Stream passive",micDisabled:"Microphone access denied by user",recording:"Recording",takeScreenshot:"Take Screenshot",discardMediaFile:"Discard Media"}};function f({onDiscard:s,i18n:e}){return t("button",{className:"uppy-u-reset uppy-c-btn uppy-ScreenCapture-button uppy-ScreenCapture-button--discard",type:"button",title:e("discardMediaFile"),"aria-label":e("discardMediaFile"),onClick:s,"data-uppy-super-focusable":!0,children:t("svg",{"aria-hidden":"true",focusable:"false",className:"uppy-c-icon",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",children:[t("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})}function g({recording:s,onStartRecording:e,onStopRecording:i,i18n:r}){return s?t("button",{className:"uppy-u-reset uppy-c-btn uppy-ScreenCapture-button uppy-ScreenCapture-button--video uppy-ScreenCapture-button--stop-rec",type:"button",title:r("stopCapturing"),"aria-label":r("stopCapturing"),onClick:i,"data-uppy-super-focusable":!0,children:t("svg",{"aria-hidden":"true",focusable:"false",className:"uppy-c-icon",width:"100",height:"100",viewBox:"0 0 100 100",children:t("rect",{x:"15",y:"15",width:"70",height:"70"})})}):t("button",{className:"uppy-u-reset uppy-c-btn uppy-ScreenCapture-button uppy-ScreenCapture-button--video",type:"button",title:r("startCapturing"),"aria-label":r("startCapturing"),onClick:e,"data-uppy-super-focusable":!0,children:t("svg",{"aria-hidden":"true",focusable:"false",className:"uppy-c-icon",width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:t("path",{d:"M4.5 4.5a3 3 0 0 0-3 3v9a3 3 0 0 0 3 3h8.25a3 3 0 0 0 3-3v-9a3 3 0 0 0-3-3H4.5ZM19.94 18.75l-2.69-2.69V7.94l2.69-2.69c.944-.945 2.56-.276 2.56 1.06v11.38c0 1.336-1.616 2.005-2.56 1.06Z"})})})}function S({onScreenshot:s,i18n:e}){return t("button",{className:"uppy-u-reset uppy-c-btn uppy-ScreenCapture-button uppy-ScreenCapture-button--screenshot",type:"button",title:e("takeScreenshot"),"aria-label":e("takeScreenshot"),onClick:s,"data-uppy-super-focusable":!0,children:t("svg",{"aria-hidden":"true",focusable:"false",className:"uppy-c-icon",width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[t("path",{d:"M12 9a3.75 3.75 0 1 0 0 7.5A3.75 3.75 0 0 0 12 9Z"}),t("path",{"fill-rule":"evenodd",d:"M9.344 3.071a49.52 49.52 0 0 1 5.312 0c.967.052 1.83.585 2.332 1.39l.821 1.317c.24.383.645.643 1.11.71.386.054.77.113 1.152.177 1.432.239 2.429 1.493 2.429 2.909V18a3 3 0 0 1-3 3h-15a3 3 0 0 1-3-3V9.574c0-1.416.997-2.67 2.429-2.909.382-.064.766-.123 1.151-.178a1.56 1.56 0 0 0 1.11-.71l.822-1.315a2.942 2.942 0 0 1 2.332-1.39ZM6.75 12.75a5.25 5.25 0 1 1 10.5 0 5.25 5.25 0 0 1-10.5 0Zm12-1.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z","clip-rule":"evenodd"})]})})}function V(s){return(s-(s%=60))/60+(s>9?":":":0")+s}var v=class extends d{wrapperStyle={width:"100%",height:"100%",display:"flex"};overlayStyle={position:"absolute",width:"100%",height:"100%",background:"black",opacity:.7};infoContainerStyle={marginLeft:"auto",marginRight:"auto",marginTop:"auto",marginBottom:"auto",zIndex:1,color:"white"};infotextStyle={marginLeft:"auto",marginRight:"auto",marginBottom:"1rem",fontSize:"1.5rem"};timeStyle={display:"block",fontWeight:"bold",marginLeft:"auto",marginRight:"auto",fontSize:"3rem",fontFamily:"Courier New"};timerRunning=!1;timer;constructor(e){super(e),this.state={elapsedTime:0}}startTimer(){this.timerTick(),this.timerRunning=!0}resetTimer(){clearTimeout(this.timer),this.setState({elapsedTime:0}),this.timerRunning=!1}timerTick(){this.timer=setTimeout(()=>{this.setState(e=>({elapsedTime:e.elapsedTime+1})),this.timerTick()},1e3)}render(){let{recording:e,i18n:i}={...this.props},{elapsedTime:r}=this.state,o=V(r);return e&&!this.timerRunning&&this.startTimer(),!e&&this.timerRunning&&this.resetTimer(),e?t("div",{style:this.wrapperStyle,children:[t("div",{style:this.overlayStyle}),t("div",{style:this.infoContainerStyle,children:[t("div",{style:this.infotextStyle,children:i("recording")}),t("div",{style:this.timeStyle,children:o})]})]}):null}},k=v;function y({streamActive:s,i18n:e}){return s?t("div",{title:e("streamActive"),className:"uppy-ScreenCapture-icon--stream uppy-ScreenCapture-icon--streamActive",children:t("svg",{"aria-hidden":"true",focusable:"false",width:"24",height:"24",viewBox:"0 0 24 24",children:[t("path",{d:"M0 0h24v24H0z",opacity:".1",fill:"none"}),t("path",{d:"M0 0h24v24H0z",fill:"none"}),t("path",{d:"M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm18-7H5v1.63c3.96 1.28 7.09 4.41 8.37 8.37H19V7zM1 10v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm20-7H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"})]})}):t("div",{title:e("streamPassive"),className:"uppy-ScreenCapture-icon--stream",children:t("svg",{"aria-hidden":"true",focusable:"false",width:"24",height:"24",viewBox:"0 0 24 24",children:[t("path",{d:"M0 0h24v24H0z",opacity:".1",fill:"none"}),t("path",{d:"M0 0h24v24H0z",fill:"none"}),t("path",{d:"M21 3H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm0-4v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11z"})]})})}function b({recording:s,recordedVideo:e,onSubmit:i,capturedScreenshotUrl:r,i18n:o}){return(e||r)&&!s?t("button",{className:"uppy-u-reset uppy-c-btn uppy-ScreenCapture-button uppy-ScreenCapture-button--submit",type:"button",title:o("submitRecordedFile"),"aria-label":o("submitRecordedFile"),onClick:i,"data-uppy-super-focusable":!0,children:t("svg",{width:"12",height:"9",viewBox:"0 0 12 9",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",className:"uppy-c-icon",children:t("path",{fill:"#fff",fillRule:"nonzero",d:"M10.66 0L12 1.31 4.136 9 0 4.956l1.34-1.31L4.136 6.38z"})})}):null}var w=class extends d{videoElement=null;componentWillUnmount(){let{onStop:e}=this.props;e()}render(){let{recording:e,stream:i,recordedVideo:r,enableScreenshots:o,capturedScreenshotUrl:a}=this.props,n={playsinline:!0};return(e||!r&&!e)&&(n.muted=!0,n.autoplay=!0,n.srcObject=i),r&&!e&&(n.muted=!1,n.controls=!0,n.src=r,this.videoElement&&(this.videoElement.srcObject=null)),t("div",{className:"uppy uppy-ScreenCapture-container",children:[t("div",{className:"uppy-ScreenCapture-mediaContainer",children:[t(y,{...this.props}),a&&!e&&!r?t("div",{className:"uppy-ScreenCapture-imageContainer",children:t("img",{src:a,className:"uppy-ScreenCapture-media",alt:"screenshotPreview"})}):t("video",{ref:c=>{this.videoElement=c},className:"uppy-ScreenCapture-media",...n}),t("div",{children:t(k,{...this.props})})]}),t("div",{className:"uppy-ScreenCapture-buttonContainer",children:r||a?t(m,{children:[t(b,{...this.props}),t(f,{...this.props})]}):t(m,{children:[o&&!e&&t(S,{...this.props}),t(g,{...this.props})]})})]})}},P=w;function x(){return t("svg",{className:"uppy-DashboardTab-iconScreenRec","aria-hidden":"true",focusable:"false",width:"32",height:"32",viewBox:"0 0 32 32",children:t("g",{fill:"currentcolor",fillRule:"evenodd",children:[t("path",{d:"M24.182 9H7.818C6.81 9 6 9.742 6 10.667v10c0 .916.81 1.666 1.818 1.666h4.546V24h7.272v-1.667h4.546c1 0 1.809-.75 1.809-1.666l.009-10C26 9.742 25.182 9 24.182 9zM24 21H8V11h16v10z"}),t("circle",{cx:"16",cy:"16",r:"2"})]})})}function D(){return window.MediaRecorder&&navigator.mediaDevices?.getDisplayMedia}function U(){return window.MediaRecorder&&navigator.mediaDevices}var N=["image/png","image/jpeg","image/webp"],B={displayMediaConstraints:{video:{width:1280,height:720,frameRate:{ideal:3,max:5},cursor:"motion",displaySurface:"monitor"}},userMediaConstraints:{audio:!0},preferredVideoMimeType:"video/webm",preferredImageMimeType:"image/png",enableScreenshots:!0},p=class extends R{static VERSION=M.version;mediaDevices;protocol;icon;streamInterrupted;captureActive;capturedMediaFile;videoStream=null;audioStream=null;userDenied=!1;recorder=null;outputStream=null;recordingChunks=null;constructor(e,i){super(e,{...B,...i}),this.mediaDevices=U(),this.protocol=location.protocol==="https:"?"https":"http",this.id=this.opts.id||"ScreenCapture",this.type="acquirer",this.icon=x,this.defaultLocale=j,this.i18nInit(),this.title=this.i18n("pluginNameScreenCapture"),this.install=this.install.bind(this),this.setPluginState=this.setPluginState.bind(this),this.render=this.render.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.startRecording=this.startRecording.bind(this),this.stopRecording=this.stopRecording.bind(this),this.submit=this.submit.bind(this),this.streamInterrupted=this.streamInactivated.bind(this),this.captureScreenshot=this.captureScreenshot.bind(this),this.discardRecordedMedia=this.discardRecordedMedia.bind(this),this.captureActive=!1,this.capturedMediaFile=null,this.setPluginState({streamActive:!1,audioStreamActive:!1,recording:!1,recordedVideo:null,screenRecError:null,capturedScreenshotUrl:null,status:"init"})}install(){if(!D())return this.uppy.log("Screen recorder access is not supported","warning"),null;this.setPluginState({streamActive:!1,audioStreamActive:!1,status:"init"});let{target:e}=this.opts;e&&this.mount(e,this)}uninstall(){this.videoStream&&this.stop(),this.unmount()}start(){return this.mediaDevices?(this.captureActive=!0,this.selectAudioStreamSource(),this.selectVideoStreamSource().then(e=>{e===!1&&this.parent?.hideAllPanels&&(this.parent.hideAllPanels(),this.captureActive=!1)})):Promise.reject(new Error("Screen recorder access not supported"))}selectVideoStreamSource(){return this.videoStream?new Promise(e=>e(this.videoStream)):this.mediaDevices.getDisplayMedia(this.opts.displayMediaConstraints).then(e=>(this.videoStream=e,this.videoStream.addEventListener("inactive",()=>{this.streamInactivated()}),this.setPluginState({streamActive:!0,status:"ready",screenRecError:null}),e)).catch(e=>(this.setPluginState({screenRecError:e,status:"error"}),this.userDenied=!0,setTimeout(()=>{this.userDenied=!1},1e3),!1))}selectAudioStreamSource(){return this.audioStream?new Promise(e=>e(this.audioStream)):this.mediaDevices.getUserMedia(this.opts.userMediaConstraints).then(e=>(this.audioStream=e,this.setPluginState({audioStreamActive:!0}),e)).catch(e=>(e.name==="NotAllowedError"&&(this.uppy.info(this.i18n("micDisabled"),"error",5e3),this.uppy.log(this.i18n("micDisabled"),"warning")),!1))}startRecording(){let e={};this.capturedMediaFile=null,this.recordingChunks=[];let{preferredVideoMimeType:i}=this.opts;this.selectVideoStreamSource().then(r=>{if(r===!1)throw new Error("No video stream available");i&&MediaRecorder.isTypeSupported(i)&&l(i)&&(e.mimeType=i);let o=[r.getVideoTracks()[0]];this.audioStream&&o.push(this.audioStream.getAudioTracks()[0]),this.outputStream=new MediaStream(o),this.recorder=new MediaRecorder(this.outputStream,e),this.recorder.addEventListener("dataavailable",a=>{this.recordingChunks.push(a.data)}),this.recorder.start(),this.setPluginState({recording:!0,status:"recording"})}).catch(r=>{this.uppy.log(r,"error"),this.setPluginState({screenRecError:r,status:"error"})})}streamInactivated(){let{recordedVideo:e,recording:i}={...this.getPluginState()};!e&&!i?(this.parent?.hideAllPanels&&this.parent.hideAllPanels(),this.setPluginState({status:"init"})):i&&(this.uppy.log("Capture stream inactive \u2014 stop recording"),this.stopRecording()),this.videoStream=null,this.audioStream=null,this.setPluginState({streamActive:!1,audioStreamActive:!1})}stopRecording(){return new Promise(i=>{this.recorder.addEventListener("stop",()=>{i()}),this.recorder.stop()}).then(()=>(this.setPluginState({recording:!1}),this.getVideo())).then(i=>{this.capturedMediaFile=i,this.setPluginState({recordedVideo:URL.createObjectURL(i.data),status:"captured"})}).then(()=>{this.recordingChunks=null,this.recorder=null},i=>{throw this.recordingChunks=null,this.recorder=null,i})}discardRecordedMedia(){let{capturedScreenshotUrl:e,recordedVideo:i}=this.getPluginState();e&&URL.revokeObjectURL(e),i&&URL.revokeObjectURL(i),this.capturedMediaFile=null,this.setPluginState({recordedVideo:null,capturedScreenshotUrl:null,status:this.getPluginState().streamActive?"ready":"init"})}submit(){try{this.capturedMediaFile&&this.uppy.addFile(this.capturedMediaFile)}catch(e){e.isRestriction||this.uppy.log(e,"warning")}}stop(){this.videoStream&&(this.videoStream.getVideoTracks().forEach(r=>{r.stop()}),this.videoStream.getAudioTracks().forEach(r=>{r.stop()}),this.videoStream=null),this.audioStream&&(this.audioStream.getAudioTracks().forEach(r=>{r.stop()}),this.audioStream.getVideoTracks().forEach(r=>{r.stop()}),this.audioStream=null),this.outputStream&&(this.outputStream.getAudioTracks().forEach(r=>{r.stop()}),this.outputStream.getVideoTracks().forEach(r=>{r.stop()}),this.outputStream=null);let{capturedScreenshotUrl:e,recordedVideo:i}=this.getPluginState();e&&URL.revokeObjectURL(e),i&&URL.revokeObjectURL(i),this.setPluginState({recording:!1,streamActive:!1,audioStreamActive:!1,recordedVideo:null,capturedScreenshotUrl:null,status:"init"}),this.captureActive=!1}getVideo(){let e=this.recordingChunks[0].type,i=l(e);if(!i)return Promise.reject(new Error(`Could not retrieve recording: Unsupported media type "${e}"`));let r=`screencap-${Date.now()}.${i}`,o=new Blob(this.recordingChunks,{type:e}),a={source:this.id,name:r,data:new Blob([o],{type:e}),type:e};return Promise.resolve(a)}async captureScreenshot(){if(!this.mediaDevices?.getDisplayMedia)throw new Error("Screen capture is not supported");try{let e=this.videoStream;if(!e){let c=await this.selectVideoStreamSource();if(!c)throw new Error("Failed to get screen capture stream");e=c}let i=document.createElement("video");i.srcObject=e,await new Promise(c=>{i.onloadedmetadata=()=>{i.play(),c(null)}});let r=document.createElement("canvas");r.width=i.videoWidth,r.height=i.videoHeight;let o=r.getContext("2d");if(!o)throw new Error("Failed to get canvas context");o.drawImage(i,0,0,r.width,r.height);let a=this.opts.preferredImageMimeType;(!a||!N.includes(a))&&(this.uppy.log(`Unsupported image type "${a}", falling back to image/png`,"warning"),a="image/png");let n=1;return new Promise((c,C)=>{r.toBlob(h=>{if(!h){C(new Error("Failed to create screenshot blob"));return}let T=l(a)||"png",A={source:this.id,name:`Screenshot ${new Date().toISOString()}.${T}`,type:a,data:h};try{this.capturedMediaFile=A;let u=URL.createObjectURL(h);this.setPluginState({capturedScreenshotUrl:u,status:"captured"}),c()}catch(u){this.getPluginState().capturedScreenshotUrl&&this.setPluginState({capturedScreenshotUrl:null}),u.isRestriction||this.uppy.log(u,"error"),C(u)}finally{i.srcObject=null,r.remove(),i.remove()}},a,n)})}catch(e){throw this.uppy.log(e,"error"),e}}render(){let e=this.getPluginState();return!e.streamActive&&!this.captureActive&&!this.userDenied&&this.start(),t(P,{...e,onStartRecording:this.startRecording,onStopRecording:this.stopRecording,enableScreenshots:this.opts.enableScreenshots,onScreenshot:this.captureScreenshot,onStop:this.stop,onSubmit:this.submit,i18n:this.i18n,stream:this.videoStream,onDiscard:this.discardRecordedMedia})}};export{p as default};
//# sourceMappingURL=screen-capture.js.map
